{# _macros/02_components/_feed.twig #}

{% macro default(config) %}
    {% import '_macros/02_components/_card' as cards %}
    {% import '_macros/03_modules/_grantees' as grantees %}

    {% set variant = 'variant' in config|keys ? config.variant : '' %}
    {% set content = 'content' in config|keys ? config.content : null %}

    {% switch variant %}
        {% case 'grantees' %}
            {% set config = {
                'grantees': config.content.entriesGrantee,
                'feature': config.content.flagFeature,
                'action': config.content.cardAction
            } %}
            {{ grantees.granteesGrid(config) }}

        {% case 'news' %}

            <div class="blockGeneric">
                <h2 class="blockGeneric-heading">This is my news feed</h2>

                {% set cardList = content.cardNews.all() %}
                {% for item in cardList %}
                    {% set type = item.type %} {# entry or media #}
                    {% set card = type == 'entry' ? item.entriesWildcard.one() : item.assetMedia.one() %}
                    <div>
                        This is my {{ type }} card.
                    </div>
                {% endfor %}

        {% case 'bio' %}

            {% set personType = content.cardPersonType.one() %}

            <div class="blockGeneric">
                <h2 class="blockGeneric-heading">This is my {{ personType.title }} bio feed</h2>
            </div>

        {% case 'cards' %}
            {# Set manualFeed #}
            {% set manualFeed = content.children.one.cardsFeedManual %}
            {# Set autoFeed #}
            {% set autoFeed = content.children.one.cardsFeedAuto ? content.children.one.cardsFeedAuto.one.sources %}
            {# Set empty feedCards array #}
            {% set feedCards = [] %}

            {# If manual card selection #}
            {% if manualFeed|length %}
                {# For manually selected card #}
                {% for item in manualFeed %}
                    {# If media card #}
                    {% if item.type == 'audio' or item.type == 'video' %}
                        {% set feedCards = feedCards|merge([item]) %}
                    
                    {# If entry card #}
                    {% else %}
                        {% set feedCards = feedCards|merge([item.blogPostNewsItemOrGrantee.one]) %}
                    {% endif %}
                {% endfor %}
            
            {# Auto cards #}
            {% else %}
                {% set sources = [] %}

                {% for source in autoFeed %}
                    {% set sources = sources|merge([source.value]) %}
                {% endfor %}

                {% set autoCards = craft.entries().section(sources).limit(3) %}
                {% for card in autoCards %}
                    {% set feedCards = feedCards|merge([card]) %}
                {% endfor %}
            {% endif %}

            <div class="cardRow" data-columns="{{ feedCards|length }}">
                {% for card in feedCards %}
                    {% if card.type == 'audio' or card.type == 'video' %}
                        {% set cardConfig  = {
                            'variant': card.type,
                            'image': card.assetImage.one(),
                            'label': card.label,
                            'title': card.cardTitle,
                            'videoUrl': card.type == 'video' ? card.videoUrl : null,
                            'action': card.type == 'video' ? card.actionLink : null,
                            'audioSnippet': card.type == 'audio' ? card.audioSnippet.one : null
                        } %}
                        {{ cards.media(cardConfig) }}
                    {% else %}
                        {% if card.section.handle == 'grantees' %}
                            {% set grantee = card %}
                            {% set granteeCardConfig = {
                                'grantee': grantee
                            } %}

                            {{ cards.grantee(granteeCardConfig) }}
                        {% else %}
                            <article class="cardItem cardItem--news">
                                <div class="cardItem__inner">
                                    {# Header #}
                                    <header class="cardItem__header">
                                        <h3 class="cardItem__heading">{{ card.title }}</h3>
                                        {% if card.label %}
                                            <span class="cardItem__label">{{ card.label }}</span>
                                        {% endif %}
                                    </header>
                                </div>
                            </article>
                        {% endif %}
                    {% endif %}
                {% endfor %}
            </div>

        {% default %}
            <div class="blockGeneric">
                <h2 class="blockGeneric-heading">This is my default card block</h2>
            </div>

    {% endswitch %}
{% endmacro %}